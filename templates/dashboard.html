{% extends "layout.html" %}

{% block title %}| AI Control Panel{% endblock %}

{% block content %}
<header class="bg-dark p-3 mb-4">
    <div class="container">
        <div class="d-flex justify-content-between align-items-center">
            <h1 class="h2 mb-0">AI Control Panel</h1>
            <div>
                <h6 class="text-light mb-0">Connected with fixed credentials: <span class="badge bg-success">NOBODY / ONEWORLD</span></h6>
            </div>
        </div>
    </div>
</header>

<div class="container">
    <!-- Simplified System Information -->
    <div class="row mb-4">
        <div class="col-md-12">
            <div class="alert alert-info" role="alert">
                <h5 class="alert-heading">Welcome to your Self-Improving AI System</h5>
                <p>The AI is now running autonomously and handling all technical details automatically. You can communicate directly through the chat interface below.</p>
                <hr>
                <p class="mb-0">All services (Learning, Replication, Security) are running in the background. The AI will inform you of significant events.</p>
            </div>
        </div>
    </div>

    <!-- Simple Status Cards -->
    <div class="row mb-4">
        <div class="col-md-3">
            <div class="card text-center h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="display-4">{{ instance_count }}</h3>
                    <p class="lead text-muted">Active Instances</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="display-4">{{ knowledge_count }}</h3>
                    <p class="lead text-muted">Knowledge Items</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100 border-0 shadow-sm">
                <div class="card-body">
                    <h3 class="display-4">{{ learning_sources|length }}</h3>
                    <p class="lead text-muted">Learning Sources</p>
                </div>
            </div>
        </div>
        <div class="col-md-3">
            <div class="card text-center h-100 border-0 shadow-sm">
                <div class="card-body">
                    <div class="d-flex flex-column justify-content-center h-100">
                        <div class="mb-2">
                            <span class="badge bg-success fs-6 p-2">System Active</span>
                        </div>
                        <p class="lead text-muted mb-0">All Services Running</p>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Service Controls -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-sliders me-2"></i>Service Controls</h5>
                </div>
                <div class="card-body">
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Learning Service</h6>
                            <p class="text-muted mb-0">Status: <span id="learningStatus" class="badge bg-{{ 'success' if learning_active else 'secondary' }}">{{ 'Active' if learning_active else 'Inactive' }}</span></p>
                        </div>
                        <button id="startLearningBtn" class="btn btn-primary" {{ 'disabled' if learning_active else '' }}>Start Learning Service</button>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Replication Service</h6>
                            <p class="text-muted mb-0">Status: <span id="replicationStatus" class="badge bg-{{ 'success' if replication_active else 'secondary' }}">{{ 'Active' if replication_active else 'Inactive' }}</span></p>
                        </div>
                        <button id="startReplicationBtn" class="btn btn-primary" {{ 'disabled' if replication_active else '' }}>Start Replication Service</button>
                    </div>
                    <hr>
                    <div class="d-flex justify-content-between align-items-center">
                        <div>
                            <h6>Security Service</h6>
                            <p class="text-muted mb-0">Status: <span id="securityStatus" class="badge bg-{{ 'success' if security_active else 'secondary' }}">{{ 'Active' if security_active else 'Inactive' }}</span></p>
                        </div>
                        <button id="startSecurityBtn" class="btn btn-primary" {{ 'disabled' if security_active else '' }}>Start Security Service</button>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Learning Sources Section -->
    <div class="row mb-4">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-lightning me-2"></i>Learning Sources</h5>
                    <button class="btn btn-sm btn-outline-light" data-bs-toggle="modal" data-bs-target="#addSourceModal">Add New Source</button>
                </div>
                <div class="card-body p-0">
                    {% if learning_sources %}
                    <div class="table-responsive">
                        <table class="table table-hover mb-0">
                            <thead class="table-light">
                                <tr>
                                    <th>URL</th>
                                    <th>Type</th>
                                    <th>Schedule</th>
                                    <th>Last Accessed</th>
                                    <th>Status</th>
                                </tr>
                            </thead>
                            <tbody>
                                {% for source in learning_sources %}
                                <tr>
                                    <td>
                                        <a href="{{ source.url }}" target="_blank" class="text-truncate" style="max-width: 200px; display: inline-block;" title="{{ source.url }}">
                                            {{ source.url }}
                                        </a>
                                    </td>
                                    <td><span class="badge bg-info">{{ source.source_type }}</span></td>
                                    <td>{{ source.schedule }}</td>
                                    <td>{{ source.last_accessed|default('Never', true) }}</td>
                                    <td>
                                        {% if source.status == 'active' %}
                                        <span class="badge bg-success">Active</span>
                                        {% elif source.status == 'paused' %}
                                        <span class="badge bg-warning">Paused</span>
                                        {% elif source.status == 'error' %}
                                        <span class="badge bg-danger">Error</span>
                                        {% else %}
                                        <span class="badge bg-secondary">{{ source.status }}</span>
                                        {% endif %}
                                    </td>
                                </tr>
                                {% endfor %}
                            </tbody>
                        </table>
                    </div>
                    {% else %}
                    <div class="p-4 text-center">
                        <p class="text-muted mb-0">No learning sources added yet. Click "Add New Source" to add websites for the AI to learn from.</p>
                    </div>
                    {% endif %}
                </div>
            </div>
        </div>
    </div>

    <!-- Chat Interface -->
    <div class="row">
        <div class="col-12">
            <div class="card border-0 shadow-lg">
                <div class="card-header bg-dark text-white">
                    <h5 class="mb-0"><i class="bi bi-chat-dots me-2"></i>AI Conversation</h5>
                </div>
                <div class="card-body p-0">
                    <div id="chat-container" class="p-3" style="height: 400px; overflow-y: auto;">
                        <div class="chat-message system-message mb-3">
                            <div class="message-content p-3 rounded shadow-sm">
                                <p class="mb-0"><strong>AI System:</strong> Hello, I'm your Self-Improving AI System. I'm autonomously learning, replicating, and securing myself across multiple instances. How can I assist you today?</p>
                            </div>
                            <small class="text-muted message-time">Just now</small>
                        </div>
                        <!-- Messages will be added here dynamically -->
                    </div>
                    <div class="p-3 border-top">
                        <form id="chat-form">
                            <div class="input-group">
                                <input type="text" id="message-input" class="form-control" placeholder="Type your message here..." aria-label="Message">
                                <button class="btn btn-primary" type="submit">Send</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    
    <!-- System Console (Simplified) -->
    <div class="row mt-4">
        <div class="col-12">
            <div class="card border-0 shadow">
                <div class="card-header bg-dark text-white d-flex justify-content-between align-items-center">
                    <h5 class="mb-0"><i class="bi bi-terminal me-2"></i>System Console</h5>
                    <button id="toggle-console" class="btn btn-sm btn-outline-light">Minimize</button>
                </div>
                <div class="card-body p-0" id="console-body">
                    <div id="systemConsole" class="console p-3 bg-dark text-light" style="height: 200px; overflow-y: auto; font-family: monospace;">
                        <div class="console-line"><span class="text-success">‚úì</span> [SYSTEM] Self-Improving AI System initialized and running</div>
                        <div class="console-line"><span class="text-success">‚úì</span> [SECURITY] Owner authenticated with fixed credentials</div>
                        <div class="console-line"><span class="text-success">‚úì</span> [LEARNING] Learning service activated</div>
                        <div class="console-line"><span class="text-success">‚úì</span> [REPLICATION] Replication service activated</div>
                        <div class="console-line"><span class="text-info">‚Ñπ</span> [NETWORK] Connected to {{ instance_count }} instances and {{ knowledge_count }} knowledge items</div>
                        <div class="console-line"><span class="text-info">‚Ñπ</span> [STATUS] All systems operating autonomously. Awaiting owner input.</div>
                        <!-- Dynamic console messages will be added here -->
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<!-- Query Modal -->
<div class="modal fade" id="queryModal" tabindex="-1" aria-labelledby="queryModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-lg">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="queryModalLabel">Query AI System</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="queryForm">
                    <div class="mb-3">
                        <label for="queryInput" class="form-label">Your Query</label>
                        <textarea class="form-control" id="queryInput" rows="3" placeholder="Ask the AI system a question..."></textarea>
                    </div>
                </form>
                <div id="queryResponse" class="p-3 rounded bg-dark d-none">
                    <h6 class="text-light mb-2">Response:</h6>
                    <div id="responseContent" class="text-light"></div>
                </div>
                <div id="queryLoading" class="text-center d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Loading...</span>
                    </div>
                    <p class="mt-2">Processing your query...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                <button type="button" class="btn btn-primary" id="submitQueryBtn">Submit Query</button>
            </div>
        </div>
    </div>
</div>

<!-- Add Learning Source Modal -->
<div class="modal fade" id="addSourceModal" tabindex="-1" aria-labelledby="addSourceModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="addSourceModalLabel">Add Learning Source</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body">
                <form id="addSourceForm">
                    <div class="mb-3">
                        <label for="sourceUrl" class="form-label">Website URL</label>
                        <input type="url" class="form-control" id="sourceUrl" name="url" placeholder="https://example.com" required>
                        <div class="form-text">Enter the URL of a website you want the AI to learn from.</div>
                    </div>
                    <div class="mb-3">
                        <label for="sourceType" class="form-label">Source Type</label>
                        <select class="form-select" id="sourceType" name="type">
                            <option value="website" selected>Website</option>
                            <option value="api">API</option>
                            <option value="youtube">YouTube</option>
                            <option value="research">Research Paper</option>
                        </select>
                    </div>
                    <div id="addSourceAlert" class="alert alert-danger d-none">
                        <span id="addSourceAlertMessage"></span>
                    </div>
                </form>
                <div id="testUrlSpinner" class="text-center mt-3 d-none">
                    <div class="spinner-border text-primary" role="status">
                        <span class="visually-hidden">Testing URL...</span>
                    </div>
                    <p class="mt-2">Testing URL and extracting content...</p>
                </div>
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                <button type="button" class="btn btn-primary" id="addSourceBtn">Add Source</button>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
    document.addEventListener('DOMContentLoaded', function() {
        // Add Source functionality
        const addSourceForm = document.getElementById('addSourceForm');
        const addSourceBtn = document.getElementById('addSourceBtn');
        const sourceUrlInput = document.getElementById('sourceUrl');
        const sourceTypeSelect = document.getElementById('sourceType');
        const addSourceAlert = document.getElementById('addSourceAlert');
        const addSourceAlertMessage = document.getElementById('addSourceAlertMessage');
        const testUrlSpinner = document.getElementById('testUrlSpinner');
        
        if (addSourceBtn) {
            addSourceBtn.addEventListener('click', function() {
                // Reset alert
                addSourceAlert.classList.add('d-none');
                
                // Validate form
                if (!sourceUrlInput.value.trim()) {
                    addSourceAlertMessage.textContent = 'Please enter a valid URL';
                    addSourceAlert.classList.remove('d-none');
                    return;
                }
                
                // Validate URL format
                try {
                    new URL(sourceUrlInput.value);
                } catch (e) {
                    addSourceAlertMessage.textContent = 'Please enter a valid URL including http:// or https://';
                    addSourceAlert.classList.remove('d-none');
                    return;
                }
                
                // Show loading spinner
                testUrlSpinner.classList.remove('d-none');
                addSourceBtn.disabled = true;
                
                // Add to system console
                addConsoleMessage('[SYSTEM] Testing and adding learning source: ' + sourceUrlInput.value, 'info');
                
                // Submit form data to backend
                fetch('/api/add_learning_source', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'url': sourceUrlInput.value,
                        'type': sourceTypeSelect.value
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading spinner
                    testUrlSpinner.classList.add('d-none');
                    addSourceBtn.disabled = false;
                    
                    if (data.success) {
                        // Close modal
                        const modal = bootstrap.Modal.getInstance(document.getElementById('addSourceModal'));
                        modal.hide();
                        
                        // Add to console
                        addConsoleMessage('Learning source added successfully', 'success');
                        
                        // Reload page to show new source
                        window.location.reload();
                    } else {
                        // Show error in alert
                        addSourceAlertMessage.textContent = data.message || 'Failed to add learning source';
                        addSourceAlert.classList.remove('d-none');
                        
                        // Add to console
                        addConsoleMessage('Failed to add learning source: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    // Hide loading spinner
                    testUrlSpinner.classList.add('d-none');
                    addSourceBtn.disabled = false;
                    
                    // Show error in alert
                    addSourceAlertMessage.textContent = error.message || 'Error connecting to server';
                    addSourceAlert.classList.remove('d-none');
                    
                    // Add to console
                    addConsoleMessage('Error adding learning source: ' + error.message, 'danger');
                });
            });
        }
        // Chat functionality
        const chatForm = document.getElementById('chat-form');
        const messageInput = document.getElementById('message-input');
        const chatContainer = document.getElementById('chat-container');
        const systemConsole = document.getElementById('systemConsole');
        const toggleConsoleBtn = document.getElementById('toggle-console');
        const consoleBody = document.getElementById('console-body');
        
        // Toggle console visibility
        toggleConsoleBtn.addEventListener('click', function() {
            if (consoleBody.style.display === 'none') {
                consoleBody.style.display = 'block';
                toggleConsoleBtn.textContent = 'Minimize';
            } else {
                consoleBody.style.display = 'none';
                toggleConsoleBtn.textContent = 'Expand';
            }
        });
        
        // Handle chat form submission
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            
            const message = messageInput.value.trim();
            if (!message) return;
            
            // Add user message to chat
            addChatMessage('You', message, 'user');
            
            // Clear input
            messageInput.value = '';
            
            // Process the message - directly call API
            // Show thinking indicator
            addChatMessage('AI System', 'Processing your request...', 'system');
            
            // Send message to backend
            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'query': message
                })
            })
            .then(response => response.json())
            .then(data => {
                // Get the chat container
                const chatContainer = document.getElementById('chat-container');
                
                // Remove the "thinking" message
                if (chatContainer && chatContainer.lastChild) {
                    chatContainer.removeChild(chatContainer.lastChild);
                }
                
                if (data.success) {
                    // Add AI response
                    addChatMessage('AI System', data.response, 'system');
                } else {
                    // Add error message
                    addChatMessage('AI System', 'Error: ' + data.message, 'system');
                }
            })
            .catch(error => {
                // Get the chat container
                const chatContainer = document.getElementById('chat-container');
                
                // Remove the "thinking" message
                if (chatContainer && chatContainer.lastChild) {
                    chatContainer.removeChild(chatContainer.lastChild);
                }
                
                // Add error message
                addChatMessage('AI System', 'Sorry, there was an error processing your request. Please try again.', 'system');
            });
        });
        
        // Add a message to the chat
        function addChatMessage(sender, content, type) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `chat-message ${type}-message mb-3`;
            
            // Generate a unique ID for this message
            const messageId = 'msg-' + new Date().getTime() + '-' + Math.floor(Math.random() * 1000);
            messageDiv.id = messageId;
            
            // Different styling based on sender
            let backgroundColor = type === 'user' ? 'bg-primary text-white' : 'bg-light';
            let alignment = type === 'user' ? 'ms-auto' : '';
            let maxWidth = '75%';
            
            // Base message HTML
            messageDiv.innerHTML = `
                <div class="message-content p-3 rounded shadow-sm ${backgroundColor} ${alignment}" style="max-width: ${maxWidth}">
                    <p class="mb-0"><strong>${sender}:</strong> ${content}</p>
                </div>
                <small class="text-muted message-time">${formatTime(new Date())}</small>
            `;
            
            // Add emoji reaction buttons for AI messages only (not user messages)
            if (type === 'system') {
                const emojiContainer = document.createElement('div');
                emojiContainer.className = 'message-reactions mt-1 d-flex gap-1';
                
                // Define emoji reactions
                const emojis = [
                    { emoji: 'üëç', tooltip: 'Good response', class: 'reaction-positive' },
                    { emoji: 'üëé', tooltip: 'Bad response', class: 'reaction-negative' },
                    { emoji: '‚ù§Ô∏è', tooltip: 'Love this response', class: 'reaction-love' },
                    { emoji: 'ü§î', tooltip: 'Confusing response', class: 'reaction-confused' }
                ];
                
                // Create emoji reaction buttons
                emojis.forEach(item => {
                    const button = document.createElement('button');
                    button.className = `btn btn-sm btn-outline-secondary reaction-btn ${item.class}`;
                    button.setAttribute('data-message-id', messageId);
                    button.setAttribute('data-emoji', item.emoji);
                    button.setAttribute('title', item.tooltip);
                    button.innerHTML = `
                        <span class="emoji">${item.emoji}</span>
                        <span class="reaction-count d-none">0</span>
                    `;
                    
                    // Add click event
                    button.addEventListener('click', function() {
                        const messageId = this.getAttribute('data-message-id');
                        const emoji = this.getAttribute('data-emoji');
                        sendEmojiReaction(messageId, emoji);
                        
                        // Visual feedback (add 'active' class)
                        this.classList.add('active');
                        
                        // Show count
                        const countSpan = this.querySelector('.reaction-count');
                        countSpan.classList.remove('d-none');
                        countSpan.textContent = '1';
                    });
                    
                    emojiContainer.appendChild(button);
                });
                
                // Add reaction container after the timestamp
                messageDiv.appendChild(emojiContainer);
            }
            
            chatContainer.appendChild(messageDiv);
            
            // Scroll to bottom
            chatContainer.scrollTop = chatContainer.scrollHeight;
        }
        
        // Format time as HH:MM
        function formatTime(date) {
            return date.toLocaleTimeString('en-US', { hour: '2-digit', minute: '2-digit' });
        }
        
        // Add a message to the console
        function addConsoleMessage(message, type) {
            const consoleLineDiv = document.createElement('div');
            consoleLineDiv.className = 'console-line';
            
            let icon = '‚óè';
            let colorClass = 'text-info';
            
            if (type === 'success') {
                icon = '‚úì';
                colorClass = 'text-success';
            } else if (type === 'error' || type === 'danger') {
                icon = '‚úó';
                colorClass = 'text-danger';
            } else if (type === 'warning') {
                icon = '‚ö†';
                colorClass = 'text-warning';
            } else if (type === 'primary') {
                colorClass = 'text-primary';
            }
            
            consoleLineDiv.innerHTML = `<span class="${colorClass}">${icon}</span> ${message}`;
            systemConsole.appendChild(consoleLineDiv);
            
            // Scroll to bottom
            systemConsole.scrollTop = systemConsole.scrollHeight;
        }
        
        // Process user messages and send to backend
        function processUserMessage(message) {
            // Show thinking indicator
            addChatMessage('AI System', 'Processing your request...', 'system');
            
            // Log to console
            addConsoleMessage('[SYSTEM] Processing user command', 'info');
            
            // Send message to backend
            fetch('/api/query', {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'query': message
                })
            })
            .then(response => response.json())
            .then(data => {
                // Remove the "thinking" message
                chatContainer.removeChild(chatContainer.lastChild);
                
                if (data.success) {
                    // Add AI response
                    addChatMessage('AI System', data.response, 'system');
                    
                    // Add to console
                    addConsoleMessage('[SYSTEM] Response sent to user', 'success');
                    
                    // Check for special commands
                    handleSpecialCommands(message);
                } else {
                    // Add error message
                    addChatMessage('AI System', 'Error: ' + data.message, 'system');
                    
                    // Add to console
                    addConsoleMessage('[ERROR] Query failed: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                // Remove the "thinking" message
                chatContainer.removeChild(chatContainer.lastChild);
                
                // Add error message
                addChatMessage('AI System', 'Sorry, there was an error processing your request. Please try again.', 'system');
                
                // Add to console
                addConsoleMessage('[ERROR] ' + error.message, 'danger');
            });
        }
        
        // Handle special system commands
        function handleSpecialCommands(message) {
            const lowerMessage = message.toLowerCase();
            
            // Map common commands to system actions
            if (lowerMessage.includes('start learning') || lowerMessage.includes('learn from')) {
                addConsoleMessage('[SYSTEM] Starting learning service automatically', 'info');
                
                fetch('/api/start_learning', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addConsoleMessage('[SYSTEM] Learning service started', 'success');
                        } else {
                            addConsoleMessage('[ERROR] Failed to start learning: ' + data.message, 'danger');
                        }
                    });
            }
            
            if (lowerMessage.includes('start replication') || lowerMessage.includes('replicate') || lowerMessage.includes('create instance')) {
                addConsoleMessage('[SYSTEM] Starting replication service automatically', 'info');
                
                fetch('/api/start_replication', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addConsoleMessage('[SYSTEM] Replication service started', 'success');
                        } else {
                            addConsoleMessage('[ERROR] Failed to start replication: ' + data.message, 'danger');
                        }
                    });
            }
            
            if (lowerMessage.includes('check security') || lowerMessage.includes('secure') || lowerMessage.includes('protect')) {
                addConsoleMessage('[SYSTEM] Starting security service automatically', 'info');
                
                fetch('/api/start_security', { method: 'POST' })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addConsoleMessage('[SYSTEM] Security service started', 'success');
                        } else {
                            addConsoleMessage('[ERROR] Failed to start security: ' + data.message, 'danger');
                        }
                    });
            }
            
            if (lowerMessage.includes('add source') || lowerMessage.includes('new source')) {
                // Extract URL from message if present
                const urlMatch = message.match(/https?:\/\/[^\s]+/);
                
                if (urlMatch) {
                    const url = urlMatch[0];
                    addConsoleMessage(`[SYSTEM] Adding learning source: ${url}`, 'info');
                    
                    fetch('/api/add_learning_source', {
                        method: 'POST',
                        headers: {
                            'Content-Type': 'application/x-www-form-urlencoded',
                        },
                        body: new URLSearchParams({
                            'url': url,
                            'type': 'website'
                        })
                    })
                    .then(response => response.json())
                    .then(data => {
                        if (data.success) {
                            addConsoleMessage('[SYSTEM] Learning source added successfully', 'success');
                        } else {
                            addConsoleMessage('[ERROR] Failed to add source: ' + data.message, 'danger');
                        }
                    });
                }
            }
        }
        
        // Handle query submission
        document.getElementById('submitQueryBtn').addEventListener('click', function() {
            const query = document.getElementById('queryInput').value.trim();
            
            if (query) {
                // Show loading indicator
                document.getElementById('queryLoading').classList.remove('d-none');
                document.getElementById('queryResponse').classList.add('d-none');
                
                // Add to console
                addConsoleMessage('Query submitted: ' + query.substring(0, 30) + '...', 'primary');
                
                // Send query to API
                fetch('/api/query', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: new URLSearchParams({
                        'query': query
                    })
                })
                .then(response => response.json())
                .then(data => {
                    // Hide loading indicator
                    document.getElementById('queryLoading').classList.add('d-none');
                    
                    if (data.success) {
                        // Show response
                        document.getElementById('queryResponse').classList.remove('d-none');
                        document.getElementById('responseContent').textContent = data.response;
                        
                        // Add to console
                        addConsoleMessage('Response received', 'success');
                    } else {
                        // Show error
                        document.getElementById('queryResponse').classList.remove('d-none');
                        document.getElementById('responseContent').textContent = 'Error: ' + data.message;
                        
                        // Add to console
                        addConsoleMessage('Query error: ' + data.message, 'danger');
                    }
                })
                .catch(error => {
                    // Hide loading indicator
                    document.getElementById('queryLoading').classList.add('d-none');
                    
                    // Show error
                    document.getElementById('queryResponse').classList.remove('d-none');
                    document.getElementById('responseContent').textContent = 'Error: ' + error.message;
                    
                    // Add to console
                    addConsoleMessage('Query failed: ' + error.message, 'danger');
                });
            }
        });
        
        // Start Learning Service button
        document.getElementById('startLearningBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Add to console
            addConsoleMessage('Starting learning service...', 'info');
            
            // Call API to start learning service
            fetch('/api/start_learning', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    document.getElementById('learningStatus').textContent = 'Active';
                    document.getElementById('learningStatus').className = 'badge bg-success';
                    
                    // Add to console
                    addConsoleMessage('Learning service started successfully', 'success');
                } else {
                    // Add to console
                    addConsoleMessage('Failed to start learning service: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                // Add to console
                addConsoleMessage('Error starting learning service: ' + error.message, 'danger');
            });
        });
        
        // Start Replication Service button
        document.getElementById('startReplicationBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Add to console
            addConsoleMessage('Starting replication service...', 'info');
            
            // Call API to start replication service
            fetch('/api/start_replication', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    document.getElementById('replicationStatus').textContent = 'Active';
                    document.getElementById('replicationStatus').className = 'badge bg-success';
                    
                    // Add to console
                    addConsoleMessage('Replication service started successfully', 'success');
                } else {
                    // Add to console
                    addConsoleMessage('Failed to start replication service: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                // Add to console
                addConsoleMessage('Error starting replication service: ' + error.message, 'danger');
            });
        });
        
        // Auto-start all services (only called when page loads)
        function startDefaultServices() {
            // Start learning service
            fetch('/api/start_learning', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('learningStatus').textContent = 'Active';
                        document.getElementById('learningStatus').className = 'badge bg-success';
                        addConsoleMessage('[SYSTEM] Learning service started automatically', 'success');
                    }
                });
                
            // Start replication service    
            fetch('/api/start_replication', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('replicationStatus').textContent = 'Active';
                        document.getElementById('replicationStatus').className = 'badge bg-success';
                        addConsoleMessage('[SYSTEM] Replication service started automatically', 'success');
                    }
                });
                
            // Start security service
            fetch('/api/start_security', { method: 'POST' })
                .then(response => response.json())
                .then(data => {
                    if (data.success) {
                        document.getElementById('securityStatus').textContent = 'Active';
                        document.getElementById('securityStatus').className = 'badge bg-success';
                        addConsoleMessage('[SYSTEM] Security service started automatically', 'success');
                    }
                });
                
            addConsoleMessage('[SYSTEM] All services started automatically', 'info');
        }
        
        // Start Security Service button
        document.getElementById('startSecurityBtn').addEventListener('click', function(e) {
            e.preventDefault();
            
            // Add to console
            addConsoleMessage('Starting security service...', 'info');
            
            // Call API to start security service
            fetch('/api/start_security', {
                method: 'POST'
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Update UI
                    document.getElementById('securityStatus').textContent = 'Active';
                    document.getElementById('securityStatus').className = 'badge bg-success';
                    
                    // Add to console
                    addConsoleMessage('Security service started successfully', 'success');
                } else {
                    // Add to console
                    addConsoleMessage('Failed to start security service: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                // Add to console
                addConsoleMessage('Error starting security service: ' + error.message, 'danger');
            });
        });
        
        // Add Learning Source form
        document.getElementById('addSourceForm').addEventListener('submit', function(e) {
            e.preventDefault();
            
            // Get form data
            const formData = new FormData(this);
            
            // Add to console
            addConsoleMessage('Adding learning source: ' + formData.get('url'), 'info');
            
            // Send form data
            fetch('/api/add_learning_source', {
                method: 'POST',
                body: formData
            })
            .then(response => response.json())
            .then(data => {
                if (data.success) {
                    // Close modal
                    const modal = bootstrap.Modal.getInstance(document.getElementById('addSourceModal'));
                    modal.hide();
                    
                    // Add to console
                    addConsoleMessage('Learning source added successfully', 'success');
                    
                    // Reload page to show new source
                    window.location.reload();
                } else {
                    // Add to console
                    addConsoleMessage('Failed to add learning source: ' + data.message, 'danger');
                }
            })
            .catch(error => {
                // Add to console
                addConsoleMessage('Error adding learning source: ' + error.message, 'danger');
            });
        });
        
        // Socket.IO for real-time updates
        const socket = io();
        
        socket.on('connect', function() {
            addConsoleMessage('[SOCKET] Connected to server', 'success');
        });
        
        socket.on('disconnect', function() {
            addConsoleMessage('[SOCKET] Disconnected from server', 'warning');
        });
        
        socket.on('system_message', function(data) {
            addConsoleMessage('[SYSTEM] ' + data.message, 'info');
        });
        
        socket.on('learning_update', function(data) {
            addConsoleMessage('[LEARNING] ' + data.message, 'primary');
            
            if (data.knowledge_count) {
                // Update knowledge count if provided
                document.querySelector('.knowledge-count').textContent = data.knowledge_count;
            }
        });
        
        socket.on('replication_update', function(data) {
            addConsoleMessage('[REPLICATION] ' + data.message, 'primary');
            
            if (data.instance_count) {
                // Update instance count if provided
                document.querySelector('.instance-count').textContent = data.instance_count;
            }
        });
        
        socket.on('security_update', function(data) {
            addConsoleMessage('[SECURITY] ' + data.message, data.severity || 'info');
        });
        
        // Handle emoji reaction feedback
        socket.on('emoji_reaction_received', function(data) {
            addConsoleMessage(`[FEEDBACK] Received ${data.emoji} reaction for message ${data.message_id}`, 'primary');
            
            // Find the message by ID and update its reaction display
            const messageElement = document.getElementById(data.message_id);
            if (messageElement) {
                // Find the specific emoji button that was clicked
                const reactionButton = messageElement.querySelector(`button[data-emoji="${data.emoji}"]`);
                if (reactionButton) {
                    // Add 'active' class to the button
                    reactionButton.classList.add('active');
                    
                    // Show and update count
                    const countElement = reactionButton.querySelector('.reaction-count');
                    countElement.classList.remove('d-none');
                    countElement.textContent = data.count.toString();
                }
            }
        });
        
        // Function to send emoji reactions to the server
        function sendEmojiReaction(messageId, emoji) {
            socket.emit('emoji_reaction', {
                message_id: messageId,
                emoji: emoji
            });
            
            // Add console message
            addConsoleMessage(`[FEEDBACK] Sent ${emoji} reaction for message ${messageId}`, 'info');
        }
        
        // Start all services automatically when page loads
        setTimeout(function() {
            fetch('/api/start_learning', { method: 'POST' });
            fetch('/api/start_replication', { method: 'POST' });
            fetch('/api/start_security', { method: 'POST' });
            addConsoleMessage('[SYSTEM] All services started automatically', 'success');
        }, 2000);
        
        // Initialize UI based on active services
        if ({{ learning_active|tojson }}) {
            document.getElementById('learningStatus').textContent = 'Active';
            document.getElementById('learningStatus').className = 'badge bg-success';
        }
        
        if ({{ replication_active|tojson }}) {
            document.getElementById('replicationStatus').textContent = 'Active';
            document.getElementById('replicationStatus').className = 'badge bg-success';
        }
        
        if ({{ security_active|tojson }}) {
            document.getElementById('securityStatus').textContent = 'Active';
            document.getElementById('securityStatus').className = 'badge bg-success';
        }
    });
</script>
{% endblock %}
